<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Datanet Interface</title>
    <style>
      body {
        background: #000;
        color: #0f0;
        font-family: monospace;
        margin: 0;
        display: flex;
        height: 100vh;
      }

      #left-panel {
        width: 30%;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
      }
      input {
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 5px;
        width: 100%;
      }
      #results { margin-top: 20px; }
      #toolbar { margin-top: 20px; }
      #file-list { list-style: none; padding-left: 0; margin-top: 10px; }
      #file-list li { display: flex; align-items: center; padding: 4px 0; }
      #file-list li .icon { width: 20px; }
      #file-list li .name { flex: 1; cursor: pointer; }
      #file-list li .actions { margin-left: 10px; }
      #file-list li .actions span { cursor: pointer; margin-left: 5px; }
      #side-panel {
        flex: 1;
        background: #111;
        color: #0f0;
        border-left: 1px solid #0f0;
        padding: 20px;
        overflow-y: auto;
      }
      #side-content {
        white-space: normal;
      }
      #side-panel h3 {
        margin-top: 0;
      }
      #side-panel h1,
      #side-panel h2,
      #side-panel h3,
      #side-panel h4,
      #side-panel h5,
      #side-panel h6,
      #side-panel p {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="left-panel">
      <h1>Welcome to the Datanet In-World Database</h1>
      <input type="text" id="search" placeholder="Search the archives..." />
      <div id="results"></div>

      <h2>File Manager</h2>
      <div id="toolbar">
        <button id="new-file">New File</button>
        <button id="new-folder">New Folder</button>
        <button id="up-folder" style="display:none;">Up</button>
      </div>
      <ul id="file-list"></ul>
    </div>
    <div id="side-panel">
      <div id="side-content"></div>
    </div>
    <script>
      let fsData = JSON.parse(localStorage.getItem('fsData') || '{"name":"root","type":"dir","children":[]}');
      let currentDir = fsData;
      const dirStack = [];
      const resultsDiv = document.getElementById('results');
      const fileList = document.getElementById('file-list');
      const newFileBtn = document.getElementById('new-file');
      const newFolderBtn = document.getElementById('new-folder');
      const upFolderBtn = document.getElementById('up-folder');
      const sidePanel = document.getElementById('side-panel');
      const sideContent = document.getElementById('side-content');

      function typeText(el, text, duration, cb) {
        el.textContent = '';
        let i = 0;
        const interval = text.length > 0 ? duration / text.length : duration;
        (function type() {
          if (i <= text.length) {
            el.textContent = text.slice(0, i);
            i++;
            if (i <= text.length) {
              setTimeout(type, interval);
            } else if (cb) {
              cb();
            }
          }
        })();
      }

      function escapeHtml(str) {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      function parseMarkdown(text) {
        let html = escapeHtml(text || '');
        html = html
          .replace(/^###### (.*)$/gm, '<h6>$1</h6>')
          .replace(/^##### (.*)$/gm, '<h5>$1</h5>')
          .replace(/^#### (.*)$/gm, '<h4>$1</h4>')
          .replace(/^### (.*)$/gm, '<h3>$1</h3>')
          .replace(/^## (.*)$/gm, '<h2>$1</h2>')
          .replace(/^# (.*)$/gm, '<h1>$1</h1>')
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/__(.+?)__/g, '<strong>$1</strong>')
          .replace(/\*(.+?)\*/g, '<em>$1</em>')
          .replace(/_(.+?)_/g, '<em>$1</em>')
          .replace(/\[([^\[]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
          .replace(/\n/g, '<br>');
        return html;
      }


      function saveData() {
        localStorage.setItem('fsData', JSON.stringify(fsData));
      }

      const searchInput = document.getElementById('search');

      if (fsData.children.length === 0) {
        fetch('database.json')
          .then(res => res.json())
          .then(json => {
            const entries = json.entries || [];
            fsData.children = entries.map(item => ({ ...item, type: 'file' }));
            saveData();
            renderFileList();
            refreshResults();
          })
          .catch(() => {
            resultsDiv.innerHTML = '<p>Error loading database.</p>';
          });
      } else {
        renderFileList();
        refreshResults();
      }

      function renderResults(results) {
        if (results.length === 0) {
          resultsDiv.innerHTML = '<p>No matching records.</p>';
          return;
        }
        const list = results
          .map(item =>
            `<li><strong>${item.name}</strong>: <span class="desc">${parseMarkdown(item.description || '')}</span></li>`
          )
          .join('');
        resultsDiv.innerHTML = `<ul>${list}</ul>`;
      }

      searchInput.addEventListener('input', () => {
        refreshResults();
      });

      function getAllFiles(dir) {
        let files = [];
        for (const child of dir.children || []) {
          if (child.type === 'file') {
            files.push(child);
          } else if (child.type === 'dir') {
            files = files.concat(getAllFiles(child));
          }
        }
        return files;
      }

      function refreshResults() {
        const query = searchInput.value.toLowerCase().trim();
        if (query === '') {
          resultsDiv.innerHTML = '';
          return;
        }
        const filtered = getAllFiles(fsData).filter(item =>
          (item.description || '').toLowerCase().includes(query) ||
          item.name.toLowerCase().includes(query)
        );
        renderResults(filtered);
      }

      function renderFileList() {
        upFolderBtn.style.display = dirStack.length > 0 ? 'inline' : 'none';
        const children = currentDir.children || [];
        if (children.length === 0) {
          fileList.innerHTML = '<li>No items.</li>';
          return;
        }
        fileList.innerHTML = children
          .map((item, index) =>
            `<li><span class="icon">${item.type === 'dir' ? 'üìÅ' : 'üìÑ'}</span>` +
            `<span class="name" data-index="${index}">${item.name}</span>` +
            `<span class="actions">` +
            `<span class="rename" data-index="${index}">‚úèÔ∏è</span> ` +
            `${item.type === 'file' ? `<span class="edit" data-index="${index}">üìù</span> ` : ''}` +
            `<span class="delete" data-index="${index}">üóëÔ∏è</span>` +
            `</span></li>`
          )
          .join('');
      }

      newFileBtn.addEventListener('click', () => {
        const name = prompt('File name:');
        if (!name) return;
        const description = prompt('Description:') || '';
        currentDir.children.push({ name, description, type: 'file' });
        saveData();
        renderFileList();
        refreshResults();
      });

      newFolderBtn.addEventListener('click', () => {
        const name = prompt('Folder name:');
        if (!name) return;
        currentDir.children.push({ name, type: 'dir', children: [] });
        saveData();
        renderFileList();
        refreshResults();
      });

      upFolderBtn.addEventListener('click', () => {
        if (dirStack.length === 0) return;
        currentDir = dirStack.pop();
        renderFileList();
        refreshResults();
      });

      fileList.addEventListener('click', e => {
        const index = e.target.dataset.index;
        if (index === undefined) return;
        const item = currentDir.children[index];
        if (e.target.classList.contains('delete')) {
          currentDir.children.splice(index, 1);
          saveData();
          renderFileList();
          refreshResults();
        } else if (e.target.classList.contains('rename')) {
          const newName = prompt('Name:', item.name);
          if (newName) {
            item.name = newName;
            saveData();
            renderFileList();
            refreshResults();
          }
        } else if (e.target.classList.contains('edit') && item.type === 'file') {
          const desc = prompt('Description:', item.description || '');
          if (desc !== null) {
            item.description = desc;
            saveData();
            renderFileList();
            refreshResults();
          }
        } else if (e.target.classList.contains('name') && item.type === 'file') {
          sideContent.innerHTML = `<h3>${item.name}</h3><div id="desc"></div>`;
          sidePanel.scrollTop = 0;
          const descEl = document.getElementById('desc');
          const temp = document.createElement('div');
          temp.innerHTML = parseMarkdown(item.description || '');
          const plain = temp.textContent || '';
          descEl.style.whiteSpace = 'pre-wrap';
          typeText(descEl, plain, 2000, () => {
            descEl.style.whiteSpace = 'normal';
            descEl.innerHTML = parseMarkdown(item.description || '');
          });
        } else if (e.target.classList.contains('name') && item.type === 'dir') {
          dirStack.push(currentDir);
          currentDir = item;
          renderFileList();
          refreshResults();
        }
      });
    </script>
  </body>
</html>
